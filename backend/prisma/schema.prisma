generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider          = "postgresql"
  url      = env("DATABASE_URL")
}

enum Specialization {
  Math
  Physics
  Chemistry
  Biology
  ComputerScience
}

//
// ========================
//        USER
// ========================
//
model User {
  id               Int                 @id @default(autoincrement())
  name             String
  email            String              @unique
  createdAt        DateTime            @default(now())
  password         String
  specialization   Specialization?

  collaborations   Collaboration[]
  ownedModules     Module[]            @relation("OwnedModules")

  dailyActivities    DailyActivity[]
  weeklyForgiveness  WeeklyForgiveness[]
}

//
// ========================
//        MODULE
// ========================
//
model Module {
  id             Int             @id @default(autoincrement())
  title          String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  archived       Boolean         @default(false)
  ownerId        Int
  coverImage     String?
  isOwner        Boolean

  collaborations Collaboration[]
  files          File[]

  owner          User @relation("OwnedModules", fields: [ownerId], references: [id])
}

//
// ========================
//        FILE
// ========================
//
model File {
  id         Int      @id @default(autoincrement())
  filename   String
  html       String?
  createdAt  DateTime @default(now())
  moduleId   Int
  s3Key      String
  s3Url      String
  embedding  Bytes?
  externalId String?  @unique

  module     Module   @relation(fields: [moduleId], references: [id])

  chat_history chat_history[]
}

//
// ========================
//      COLLABORATION
// ========================
//
model Collaboration {
  id        Int      @id @default(autoincrement())
  userId    Int
  moduleId  Int
  role      String   @default("editor")
  invitedAt DateTime @default(now())

  module    Module   @relation(fields: [moduleId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, moduleId])
}

//
// ========================
//     STREAK MODELS
// ========================
//
model DailyActivity {
  id        Int      @id @default(autoincrement())
  userId    Int
  date      DateTime
  studied   Boolean  @default(false)

  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, date])
}

model WeeklyForgiveness {
  id        Int      @id @default(autoincrement())
  userId    Int
  weekStart DateTime
  used      Boolean  @default(false)

  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, weekStart])
}

//
// ========================
//     CHAT HISTORY
// ========================
//
model chat_history {
  id        Int       @id @default(autoincrement())
  file_id   Int
  question  String
  answer    String
  timestamp DateTime? @default(now()) @db.Timestamp(6)

  file      File?     @relation(fields: [file_id], references: [id])
}

//
// ========================
//  IGNORE EXTERNAL TABLES
// ========================
//

/// @ignore
model flashcards {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String?   @db.VarChar(255)
  description String?
  file_ids    String[]
  cards       Json?
  total_cards Int?
  created_at  DateTime? @default(now()) @db.Timestamp(6)
}

/// @ignore
model tests {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title           String?   @db.VarChar(255)
  description     String?
  file_ids        String[]
  questions       Json?
  total_questions Int?
  created_at      DateTime? @default(now()) @db.Timestamp(6)
}

// /// @ignore
// model langchain_pg_collection {
//   uuid                   String                   @id @db.Uuid
//   name                   String                   @unique @db.VarChar
//   cmetadata              Json?                    @db.Json
//   langchain_pg_embedding langchain_pg_embedding[]
// }

// /// @ignore
// model langchain_pg_embedding {
//   id                      String                   @id @db.VarChar
//   collection_id           String?                  @db.Uuid
//   embedding               Unsupported("vector")?
//   document                String?                  @db.VarChar
//   cmetadata               Json?
//   langchain_pg_collection langchain_pg_collection? @relation(fields: [collection_id], references: [uuid], onDelete: Cascade, onUpdate: NoAction)

//   @@index([cmetadata(ops: JsonbPathOps)], map: "ix_cmetadata_gin", type: Gin)
// }
