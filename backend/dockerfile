FROM node:20-alpine
RUN apk add --no-cache openssl libc6-compat
WORKDIR /app

# 1) Copy package manifests
COPY package*.json ./

# 2) Copy Prisma schema BEFORE install so postinstall can find it
COPY prisma ./prisma

# 3) Install deps (this may run "postinstall": "prisma generate" if you have it)
RUN npm ci || npm install

# 4) Safety: run generate explicitly too (no-op if already run)
RUN npx prisma generate || true

# 5) Copy the rest of the app
COPY . .

EXPOSE 3001
CMD ["npm","run","dev"]